import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { Select, SelectItem, Switch, Card, CardBody, CardHeader, Button, cn, CardFooter } from '@heroui/react';
import { useApi } from '../hooks/useApi';
import { SettingsBoxes, BoxRecommendationsResponse, BoxRecommendationMode } from '../types/boxes';
import { setCookie, getCookie, deleteCookie, areCookiesEnabled } from '../lib/cookieUtils';
import { DynamicIcon } from 'lucide-react/dynamic';
import { LoggingService } from '../services/LoggingService';

interface BoxSelectorProps {
  totalPortions: number;
  onBoxesChange: (boxes: SettingsBoxes[], totalWeight: number, boxesInfo?: any) => void;
  onActiveBoxChange?: (activeBoxIndex: number) => void;
  activeBoxIndex: number; // –î–æ–¥–∞—î–º–æ activeBoxIndex —è–∫ prop
  className?: string;
}

export const BoxSelector: React.FC<BoxSelectorProps> = ({
  totalPortions,
  onBoxesChange,
  onActiveBoxChange,
  activeBoxIndex,
  className = ''
}) => {
  const { apiCall } = useApi();
  
  // –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –¥–ª—è —ñ–º–µ–Ω—ñ –∫—É–∫—ñ
  const BOX_MODE_COOKIE = 'nova_box_recommendation_mode';
  
  const [boxes, setBoxes] = useState<SettingsBoxes[]>([]);
  const [recommendations, setRecommendations] = useState<BoxRecommendationsResponse | null>(null);
  const [selectedBoxes, setSelectedBoxes] = useState<SettingsBoxes[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [lastTotalPortions, setLastTotalPortions] = useState<number>(0);
  const [recommendationMode, setRecommendationMode] = useState<BoxRecommendationMode>('spacious');
  const [transitionMode, setTransitionMode] = useState<boolean>(false);
  // const [activeBoxIndex, setActiveBoxIndex] = useState<number>(0); // –í–∏–¥–∞–ª–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–∏–π activeBoxIndex

  // –ú–µ–º–æ—ñ–∑—É—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é onBoxesChange —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª—É
  const memoizedOnBoxesChange = useCallback(onBoxesChange, []);

  // –õ–æ–≥—ñ–∫–∞ —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è —á–µ–∫-–ª–∏—Å—Ç–∞ –Ω–∞ –∫–æ—Ä–æ–±–∫–∏ (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó)
  const getPortionsPerBox = useMemo(() => {
    if (selectedBoxes.length === 0) return 0;
    return Math.ceil(totalPortions / selectedBoxes.length);
  }, [totalPortions, selectedBoxes.length]);

  // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–æ—Ä–æ–±–∫–∏
  const fetchBoxes = useCallback(async () => {
    try {
      const response = await apiCall('/api/boxes');
      
      if (response.ok) {
        const boxesData = await response.json();
        
        if (boxesData && boxesData.length > 0) {
          setBoxes(boxesData);
          setError(null);
        } else {
          setError('–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö –∫–æ—Ä–æ–±–æ–∫ –ø–æ—Ä–æ–∂–Ω—è. –ó–∞–ø—É—Å—Ç—ñ—Ç—å seed —Ñ–∞–π–ª.');
          return;
        }
      } else {
        setError(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–æ—Ä–æ–±–æ–∫: ${response.status} ${response.statusText}`);
      }
    } catch (err) {
      setError('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –∫–æ—Ä–æ–±–æ–∫');
    }
  }, [apiCall]);

  // –°–ø–æ–≤—ñ—â–∞—î–º–æ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø—Ä–æ –∑–º—ñ–Ω—É –∫–æ—Ä–æ–±–æ–∫
  const notifyBoxesChange = useCallback((newSelectedBoxes: SettingsBoxes[]) => {
    const totalWeight = newSelectedBoxes.reduce((sum, b) => sum + Number(b.weight), 0);
    
    // –û–±—á–∏—Å–ª—é—î–º–æ portionsPerBox –¥–ª—è –ø–æ—Ç–æ—á–Ω–∏—Ö –∫–æ—Ä–æ–±–æ–∫
    const portionsPerBox = Math.ceil(totalPortions / newSelectedBoxes.length);
    
    // –ü–µ—Ä–µ–¥–∞—î–º–æ –¥–æ–¥–∞—Ç–∫–æ–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è –Ω–∞ –∫–æ—Ä–æ–±–∫–∏
    const boxesInfo = {
      boxes: newSelectedBoxes,
      totalWeight,
      totalBoxes: newSelectedBoxes.length,
      portionsPerBox,
      activeBoxIndex,
      boxPortionsRanges: newSelectedBoxes.map((_, index) => {
        const start = index * portionsPerBox + 1;
        const end = Math.min((index + 1) * portionsPerBox, totalPortions);
        return { start, end };
      })
    };
    

    
    memoizedOnBoxesChange(newSelectedBoxes, totalWeight, boxesInfo);
  }, [memoizedOnBoxesChange, totalPortions, activeBoxIndex]);

  // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó
  const fetchRecommendations = useCallback(async (portions: number) => {
    try {
      const response = await apiCall(`/api/boxes/recommendations/${portions}?mode=${recommendationMode}`);
      
      if (response.ok) {
        const recommendationsData: BoxRecommendationsResponse = await response.json();
        setRecommendations(recommendationsData);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–±–∏—Ä–∞—î–º–æ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω—ñ –∫–æ—Ä–æ–±–∫–∏
        const recommendedBoxes = recommendationsData.boxes || [];
        
        // –°–ø–æ—á–∞—Ç–∫—É –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∫–æ—Ä–æ–±–∫–∏
        setSelectedBoxes(recommendedBoxes);
        
        // –ü–æ—Ç—ñ–º —Å–ø–æ–≤—ñ—â–∞—î–º–æ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
        // –ü–µ—Ä–µ–¥–∞—î–º–æ recommendedBoxes –Ω–∞–ø—Ä—è–º—É, –∞ –Ω–µ —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω
        const totalWeight = recommendedBoxes.reduce((sum, b) => sum + Number(b.weight), 0);
        
        // –û–±—á–∏—Å–ª—é—î–º–æ portionsPerBox –¥–ª—è –ø–µ—Ä–µ–¥–∞–Ω–∏—Ö –∫–æ—Ä–æ–±–æ–∫
        const portionsPerBox = Math.ceil(portions / recommendedBoxes.length);
        
        // –ü–µ—Ä–µ–¥–∞—î–º–æ –¥–æ–¥–∞—Ç–∫–æ–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è –Ω–∞ –∫–æ—Ä–æ–±–∫–∏
        const boxesInfo = {
          boxes: recommendedBoxes,
          totalWeight,
          totalBoxes: recommendedBoxes.length,
          portionsPerBox,
          activeBoxIndex: 0,
          boxPortionsRanges: recommendedBoxes.map((_, index) => {
            const start = index * portionsPerBox + 1;
            const end = Math.min((index + 1) * portionsPerBox, portions);
            return { start, end };
          })
        };
        
        memoizedOnBoxesChange(recommendedBoxes, totalWeight, boxesInfo);
      } else {
        const errorData = await response.json();
        setError(errorData.error || '–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –ø–æ –∫–æ—Ä–æ–±–∫–∞–º');
      }
    } catch (err) {
      setError('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π –ø–æ –∫–æ—Ä–æ–±–∫–∞–º');
    } finally {
      setLoading(false);
      setTransitionMode(false);
    }
  }, [apiCall, memoizedOnBoxesChange, activeBoxIndex, recommendationMode]);

  // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ä–µ–∂–∏–º—É
  const handleModeChange = useCallback((newMode: BoxRecommendationMode) => {
    LoggingService.orderAssemblyLog('üì¶ –ó–º—ñ–Ω–∞ —Ä–µ–∂–∏–º—É –∫–æ—Ä–æ–±–æ–∫:', newMode);
    
    setTransitionMode(true);
    setRecommendationMode(newMode);
    
    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ–±—Ä–∞–Ω–∏–π —Ä–µ–∂–∏–º –≤ –∫—É–∫—ñ –Ω–∞ 365 –¥–Ω—ñ–≤
    setCookie(BOX_MODE_COOKIE, newMode, { expires: 365 });
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ –∫—É–∫—ñ –≤—Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å
    setTimeout(() => {
      const savedValue = getCookie(BOX_MODE_COOKIE);
      console.log('Cookie value after setting:', savedValue);
    }, 100);
    
    // –û—á–∏—â—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –ø–æ–º–∏–ª–∫–∏ –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ä–µ–∂–∏–º—É
    setError(null);
    
    // –ü–ª–∞–≤–Ω–æ –ø—Ä–∏—Ö–æ–≤—É—î–º–æ —Å—Ç–∞—Ä—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó
    setTimeout(() => {
      setTransitionMode(false);
    }, 150);
  }, [BOX_MODE_COOKIE]);

  // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Å–∫–∏–¥–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É
  const handleResetMode = useCallback(() => {
    const defaultMode: BoxRecommendationMode = 'economical';
    setTransitionMode(true);
    setRecommendationMode(defaultMode);
    
    // –í–∏–¥–∞–ª—è—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π —Ä–µ–∂–∏–º –∑ –∫—É–∫—ñ
    deleteCookie(BOX_MODE_COOKIE);
    
    // –û—á–∏—â—É—î–º–æ –ø–æ–º–∏–ª–∫–∏
    setError(null);
    
    // –ü–ª–∞–≤–Ω–æ –ø—Ä–∏—Ö–æ–≤—É—î–º–æ —Å—Ç–∞—Ä—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó
    setTimeout(() => {
      setTransitionMode(false);
    }, 150);
  }, [BOX_MODE_COOKIE]);

  // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–æ—Ä–æ–±–∫–∏ –ø—Ä–∏ –º–æ–Ω—Ç—É–≤–∞–Ω–Ω—ñ
  useEffect(() => {
    if (boxes.length > 0) return;
    fetchBoxes();
  }, [fetchBoxes, boxes.length]);

  // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ —Ä–µ–∂–∏–º –∑ –∫—É–∫—ñ –ø—Ä–∏ –º–æ–Ω—Ç—É–≤–∞–Ω–Ω—ñ
  useEffect(() => {
    // LoggingService.orderAssemblyLog('üì¶ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ä–µ–∂–∏–º—É –∫–æ—Ä–æ–±–æ–∫ –∑ cookies...');
    
    const savedMode = getCookie(BOX_MODE_COOKIE);
    if (savedMode === 'spacious' || savedMode === 'economical') {
      // LoggingService.orderAssemblyLog('üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ä–µ–∂–∏–º –∑ cookie:', savedMode);
      setRecommendationMode(savedMode);
    } else {
      LoggingService.orderAssemblyLog('üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ä–µ–∂–∏–º –ø–∞–∫—É–≤–∞–Ω–Ω—è: economical');
    }
  }, [BOX_MODE_COOKIE]);

  // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –ø—Ä–∏ –∑–º—ñ–Ω—ñ –ø–æ—Ä—Ü—ñ–π –∞–±–æ —Ä–µ–∂–∏–º—É
  useEffect(() => {
    if (boxes.length === 0 || totalPortions <= 0 || loading) {
      return;
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∑–º—ñ–Ω–∏–ª–∏—Å—å –ø–æ—Ä—Ü—ñ—ó –∞–±–æ —Ä–µ–∂–∏–º
    const shouldFetch = totalPortions !== lastTotalPortions || 
                       (recommendations && recommendations.mode !== recommendationMode);

    if (shouldFetch) {
      // –Ø–∫—â–æ –∑–º—ñ–Ω—é—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ —Ä–µ–∂–∏–º, –Ω–µ –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
      if (totalPortions === lastTotalPortions && recommendations) {
        setTransitionMode(true);
      } else {
        setLoading(true);
      }
      setError(null);
      setLastTotalPortions(totalPortions);
      fetchRecommendations(totalPortions);
    }
  }, [totalPortions, recommendationMode, fetchRecommendations, boxes.length, lastTotalPortions, loading, recommendations]);

  // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –æ–∫—Ä–µ–º–∏–π useEffect –¥–ª—è —Ä–µ–∂–∏–º—É, –æ—Å–∫—ñ–ª—å–∫–∏ –≤—ñ–Ω —Ç–µ–ø–µ—Ä –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è –≤–∏—â–µ

  // –û–±—Ä–æ–±–Ω–∏–∫ –∑–º—ñ–Ω–∏ –≤–∏–±–æ—Ä—É –∫–æ—Ä–æ–±–∫–∏
  const handleBoxChange = useCallback((boxId: string, index: number) => {
    const box = boxes.find(b => b.id.toString() === boxId);
    if (!box) return;

    const newSelectedBoxes = [...selectedBoxes];
    newSelectedBoxes[index] = box;
    setSelectedBoxes(newSelectedBoxes);

    // –°–ø–æ–≤—ñ—â–∞—î–º–æ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø—Ä–æ –∑–º—ñ–Ω—É
    notifyBoxesChange(newSelectedBoxes);
  }, [boxes, selectedBoxes, notifyBoxesChange]);

  // –î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ—ó –∫–æ—Ä–æ–±–∫–∏
  const addBox = useCallback(() => {
    if (boxes.length > 0) {
      const newSelectedBoxes = [...selectedBoxes, boxes[0]];
      setSelectedBoxes(newSelectedBoxes);
      
      // –°–ø–æ–≤—ñ—â–∞—î–º–æ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø—Ä–æ –∑–º—ñ–Ω—É
      notifyBoxesChange(newSelectedBoxes);
    }
  }, [boxes, selectedBoxes, notifyBoxesChange]);

  // –í–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ—Ä–æ–±–∫–∏
  const removeBox = useCallback((index: number) => {
    const newSelectedBoxes = selectedBoxes.filter((_, i) => i !== index);
    setSelectedBoxes(newSelectedBoxes);
    
    // –°–ø–æ–≤—ñ—â–∞—î–º–æ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø—Ä–æ –∑–º—ñ–Ω—É
    notifyBoxesChange(newSelectedBoxes);
  }, [selectedBoxes, notifyBoxesChange]);

  // –û–±—á–∏—Å–ª—é–≤–∞–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è
  const totalBoxesWeight = useMemo(() => 
    selectedBoxes.reduce((sum, b) => sum + Number(b.weight), 0), 
    [selectedBoxes]
  );

  const totalMaxCapacity = useMemo(() => 
    selectedBoxes.reduce((sum, b) => sum + b.qntTo, 0), 
    [selectedBoxes]
  );

  // –í–∞–ª—ñ–¥–∞—Ü—ñ—è –∫–æ—Ä–æ–±–æ–∫
  const isBoxesValid = useMemo(() => {
    if (selectedBoxes.length === 0) return true;
    
    const portionsPerBox = Math.ceil(totalPortions / selectedBoxes.length);
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–æ–∂–Ω—É –∫–æ—Ä–æ–±–∫—É –æ–∫—Ä–µ–º–æ
    return selectedBoxes.every(box => box.qntTo >= portionsPerBox);
  }, [selectedBoxes, totalPortions]);

  const getBoxValidationStatus = useCallback((box: SettingsBoxes) => {
    if (selectedBoxes.length === 0) return 'default';
    const portionsPerBox = Math.ceil(totalPortions / selectedBoxes.length);
    if (box.qntTo < portionsPerBox) {
      return 'danger';
    }
    return 'default';
  }, [selectedBoxes.length, totalPortions]);

  const hasInappropriateBoxes = useMemo(() => {
    if (selectedBoxes.length === 0) return false;
    const portionsPerBox = Math.ceil(totalPortions / selectedBoxes.length);
    return selectedBoxes.some(box => box.qntTo < portionsPerBox);
  }, [selectedBoxes, totalPortions]);

  if (loading) {
    return (
      <div className={`animate-pulse ${className}`}>
        <div className="h-10 bg-gray-200 rounded"></div>
      </div>
    );
  }

  if (error) {
    return (
      <div className={`text-red-600 text-sm ${className}`}>
        {error}
      </div>
    );
  }

  return (
    <div className="w-full flex flex-col gap-2">
      {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
      {/* <div className="flex items-center justify-between">
        <h3 className="text-lg font-semibold text-gray-900">
          –ö–æ—Ä–æ–±–∫–∏
        </h3>
        <Button
          variant="solid"
          size="sm"
          color="secondary"
          className="gap-2"
          onPress={addBox}
        >
          <Plus className="w-4 h-4" /> –î–æ–¥–∞—Ç–∏
        </Button>
      </div> */}

      {/* –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó */}
      {/* {recommendations && (
        <div className={`border rounded-lg p-3 duration-300 ease-in-out ${
          recommendations.overflowWarning 
            ? 'bg-orange-50 border-orange-200' 
            : 'bg-blue-50 border-blue-200'
        } ${
          transitionMode ? 'opacity-50 transform scale-95' : 'opacity-100 transform scale-100'
        }`}>
          <div className={`text-sm ${
            console.log("recommendation object", recommendations),
            recommendations.overflowWarning ? 'text-orange-800' : 'text-blue-800'
          }`}>
            <p><strong>–†–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è:</strong> {recommendations.totalBoxes} –∫–æ—Ä–æ–±–æ–∫</p>
            <p><strong>–û–±—â–∏–π –≤–µ—Å –∫–æ—Ä–æ–±–æ–∫:</strong> {Number(recommendations.totalWeight).toFixed(1)} –∫–≥</p>
            {recommendations.remainingQuantity && recommendations.remainingQuantity > 0 && (
              <p className="text-orange-600">
                <strong>–£–≤–∞–≥–∞:</strong> {recommendations.remainingQuantity} –ø–æ—Ä—Ü—ñ–π –Ω–µ –ø–æ–º—ñ—Å—Ç–∏—Ç—å—Å—è –≤ –≤–∏–±—Ä–∞–Ω—ñ –∫–æ—Ä–æ–±–∫–∏
              </p>
            )}
            {recommendations.overflowWarning && (
              <p className="text-orange-600 font-medium">
                ‚ö†Ô∏è –í –µ–∫–æ–Ω–æ–º—ñ—á–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ –º–æ–∂–ª–∏–≤–µ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è –∫–æ—Ä–æ–±–æ–∫
              </p>
            )}
          </div>
        </div>
      )} */}

      {/* –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø—Ä–æ –Ω–µ–ø—ñ–¥—Ö–æ–¥—è—â—ñ –∫–æ—Ä–æ–±–∫–∏ */}
      {/* {hasInappropriateBoxes && (
        <div className={`bg-red-50 border border-red-200 rounded-lg p-3 duration-300 ease-in-out ${
          transitionMode ? 'opacity-50 transform scale-95' : 'opacity-100 transform scale-100'
        }`}>
          <div className="text-sm text-red-800">
            <p><strong>‚ö†Ô∏è –£–≤–∞–≥–∞:</strong> –í–∏–±—Ä–∞–Ω–æ –∫–æ—Ä–æ–±–∫–∏, —è–∫—ñ –Ω–µ –≤–º—ñ—â—É—é—Ç—å —Å–≤–æ—é —á–∞—Å—Ç–∏–Ω—É –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</p>.
            <p>–ö–æ–∂–Ω–∞ –∫–æ—Ä–æ–±–∫–∞ –ø–æ–≤–∏–Ω–Ω–∞ –≤–º—ñ—â–∞—Ç–∏ –º—ñ–Ω—ñ–º—É–º {getPortionsPerBox} –ø–æ—Ä—Ü—ñ–π</p>
          </div>
        </div>
      )} */}

      {/* –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è –Ω–∞ –∫–æ—Ä–æ–±–∫–∏ */}
      {/* {selectedBoxes.length > 1 && (
        <div className="bg-gray-50 border border-gray-200 rounded-lg p-3">
          <div className="text-sm text-gray-700">
            <p><strong>–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–∑–¥—ñ–ª–µ–Ω–µ –Ω–∞ {selectedBoxes.length} –∫–æ—Ä–æ–±–æ–∫:</strong></p>
            <p>–ü–æ {getPortionsPerBox} –ø–æ—Ä—Ü—ñ–π –Ω–∞ –∫–æ—Ä–æ–±–∫—É</p>
            <p className="text-blue-600 mt-2">
              üí° –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –≤–∫–ª–∞–¥–∫–∏ –≤ —á–µ–∫-–ª–∏—Å—Ç—ñ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–Ω—è –º—ñ–∂ –∫–æ—Ä–æ–±–∫–∞–º–∏
            </p>
          </div>
        </div>
      )} */}

      {/* –°–ø–∏—Å–æ–∫ –æ–±—Ä–∞–Ω–∏—Ö –∫–æ—Ä–æ–±–æ–∫ */}
      {selectedBoxes.map((box, index) => {
        const portionsPerBox = Math.ceil(totalPortions / selectedBoxes.length);
        const start = index * portionsPerBox + 1;
        const end = Math.min((index + 1) * portionsPerBox, totalPortions);
        const isActive = index === activeBoxIndex;
        
        return (
          <div
            key={index + 1}
            className="flex-1 cursor-pointer"
            onClick={() => onActiveBoxChange?.(index)}
          >
            <Card className={`transition-shadow duration-200 ease-in-out ${isActive && 'ring-2 ring-lime-600/80'}`}>
              <CardBody className="flex flex-row items-center gap-4">
                <DynamicIcon name="package" size={20} strokeWidth={1.5} className={`absolute left-20 top-1/2 -translate-y-1/2 scale-[3] opacity-5 ${isActive && "text-lime-700"}`} /> 
                <div className="flex flex-col gap-1">
                  <span className={`text-base font-semibold py-0 duration-200 flex items-center whitespace-nowrap gap-2 ${isActive && "text-lime-700"}`}>–ö–æ—Ä–æ–±–∫–∞ #{ index + 1 }</span>
                  <span className={`text-xs text-gray-600 ${isActive && "text-lime-700"}`}>{box.width}√ó{box.height}√ó{box.length} —Å–º</span>
                </div>
                <Select
                  aria-label="–ö–æ—Ä–æ–±–∫–∞"
                  labelPlacement='outside'
                  variant='flat'
                  color='default'
                  size='md'
                  selectedKeys={[box.id.toString()]}
                  onSelectionChange={(keys) => {
                    const selectedKey = Array.from(keys)[0]?.toString();
                    if (selectedKey) {
                      handleBoxChange(selectedKey, index);
                    }
                  }}
                  classNames={{
                    base: "max-w-xs",
                    trigger: `${isActive && "bg-lime-700/10 hover:bg-lime-500/10 shadow-lime-800/20"}`,
                  }}
                  isDisabled={transitionMode}
                  // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ —Å–ø–ª–∏–≤–∞–Ω–Ω—é –ø–æ–¥—ñ—ó –∫–ª—ñ–∫–∞ –≤—ñ–¥ Select
                  onClick={(e) => e.stopPropagation()}
                >
                  {boxes
                    .sort((a, b) => Number(a.weight) - Number(b.weight)) // –°–æ—Ä—Ç—É—î–º–æ –∑–∞ –≤–∞–≥–æ—é –≤—ñ–¥ –º–µ–Ω—à–æ–≥–æ –¥–æ –±—ñ–ª—å—à–æ–≥–æ
                    .map((boxOption) => {
                      const portionsPerBox = selectedBoxes.length > 0 ? Math.ceil(totalPortions / selectedBoxes.length) : 0;
                      return (
                        <SelectItem 
                          key={boxOption.id} 
                          textValue={`${boxOption.marking} (${boxOption.qntFrom}-${boxOption.qntTo} –ø–æ—Ä—Ü—ñ–π)`}
                        >
                          <span className={boxOption.qntTo < portionsPerBox ? 'text-red-600' : ''}>
                            {boxOption.marking} ({boxOption.qntFrom}-{boxOption.qntTo} –ø–æ—Ä—Ü—ñ–π)
                          </span>
                        </SelectItem>
                      );
                    })}
                </Select>
              </CardBody>
            </Card>
          </div>
        );
      })}

      {/* –ü–µ—Ä–µ–º–∏–∫–∞—á —Ä–µ–∂–∏–º—É –µ–∫–æ–Ω–æ–º—ñ—á–Ω–æ–≥–æ –ø–∞–∫—É–≤–∞–Ω–Ω—è */}
      <div className="flex flex-col gap-3 mt-8">
        <Switch
          isSelected={recommendationMode === 'economical'}
          onValueChange={(checked) => handleModeChange(checked ? 'economical' : 'spacious')}
          color="danger"
          classNames={{
            base: cn(
              "inline-flex flex-row-reverse w-full bg-white items-center",
              "justify-between cursor-pointer rounded-lg gap-3 px-2 py-4 pr-5",
              "data-[selected=true]:ring-danger data-[selected=true]:ring-2",
              "transition-transform duration-200 ease-in-out",
              `${transitionMode ? "opacity-75 scale-[0.98]" : "opacity-100 scale-100"}`
            ),
            wrapper: "p-0 h-4 overflow-visible",
            thumb: cn(
              "w-6 h-6 border-2 shadow-lg",
              "group-data-[hover=true]:border-danger",
              //–æ–±—Ä–∞–Ω–∏–π
              "group-data-[selected=true]:ms-6",
              "group-data-[selected=true]:border-danger",
              // –Ω–∞—Ç–∏—Å–Ω—É—Ç–∏–π
              "group-data-[pressed=true]:w-7",
              "group-data-pressed:group-data-selected:ms-4",
            ),
          }}
        >
          <div className="flex flex-col gap-2">
            <p className="text-medium font-semibold leading-[1.1]">
              –ï–∫–æ–Ω–æ–º—ñ—á–Ω–∏–π —Ä–µ–∂–∏–º –ø–∞–∫—É–≤–∞–Ω–Ω—è {recommendationMode === 'economical' && <span className="bg-danger rounded px-1 py-0.5 text-white text-[10px] tracking-wider">–£–í–Ü–ú–ö–ù–ï–ù–û</span>}
            </p>
            <p className="text-[13px] leading-snug text-default-400">–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–æ—Ä–æ–±–æ–∫, –º–æ–∂–ª–∏–≤–µ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è.</p>
          </div>
        </Switch>
      </div>

    </div>
  );
};
