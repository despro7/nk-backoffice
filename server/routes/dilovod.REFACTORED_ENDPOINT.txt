// ============================================
// SIMPLIFIED ENDPOINT CODE
// ============================================
// Замінити код ендпоінту POST /api/dilovod/salesdrive/orders/check (рядки ~691-1000)
// на цей спрощений варіант:

/**
 * POST /api/dilovod/salesdrive/orders/check
 * Перевірка наявності замовлень в Dilovod та оновлення локальної бази
 */
router.post('/salesdrive/orders/check', authenticateToken, async (req, res) => {
  try {
    // Перевіряємо ролі доступу
    if (!req.user || !['admin', 'boss', 'shop-manager'].includes(req.user.role)) {
      return res.status(403).json({
        success: false,
        error: 'Insufficient permissions. Required roles: admin, boss, shop-manager'
      });
    }

    const { orderNumbers, auto, limit } = req.body;
    const dilovodService = new DilovodService();

    // AUTO MODE - автоматична перевірка замовлень з неповними даними
    if (auto === true) {
      logWithTimestamp(`=== API [AUTO]: Перевірка замовлень без повних даних в Dilovod (limit: ${limit || 100}) ===`, undefined, true);
      
      const result = await dilovodService.checkOrderStatuses(limit || 100);
      return res.json(result);
    }

    // MANUAL MODE - перевірка конкретних номерів замовлень
    if (!Array.isArray(orderNumbers)) {
      return res.status(400).json({
        success: false,
        error: 'Bad request',
        message: 'orderNumbers must be an array or auto: true must be provided'
      });
    }

    logWithTimestamp(`=== API: Перевірка замовлень ${orderNumbers} в Dilovod ===`, undefined, true);

    const result = await dilovodService.checkOrdersByNumbers(orderNumbers);
    return res.json(result);

  } catch (error) {
    const errorMessage = handleDilovodApiError(error, 'Order check');
    logWithTimestamp('API: Помилка перевірки замовлення в Dilovod:', errorMessage);
    res.status(500).json({
      success: false,
      error: 'Dilovod API error',
      message: errorMessage
    });
  }
});

// ============================================
// SUMMARY OF CHANGES
// ============================================
// BEFORE: ~310 lines of duplicated logic
// AFTER: ~50 lines delegating to DilovodService
//
// REMOVED:
// - getDilovodSettings() call
// - pendingOrders query
// - formatOrderNumberForDilovod() loop  
// - results/baseDocIds/orderMap initialization
// - checks Promise.all() with orderDatabaseService
// - validOrders/passedOrders filtering
// - passedOrders loop
// - dilovodService.getOrderByNumber() call
// - dilovodOrders loop with baseDoc processing
// - existingOrders query
// - needSaleRequest/needCashInRequest filtering
// - getDocuments() calls for sale/cashIn
// - groupByBaseDoc() function
// - saleByBaseDoc/cashInByBaseDoc processing loops
// - successCount/errorCount/hasError logic
// - errorDetails mapping
// - message conditionals
// - Custom res.json() response formatting
//
// ADDED:
// - Simple delegation to dilovodService.checkOrderStatuses()
// - Simple delegation to dilovodService.checkOrdersByNumbers()
//
// RESULT:
// - Code reduction: ~260 lines removed
// - DRY principle: No duplication between service and route
// - Maintainability: Single source of truth in DilovodService
// - Testing: Service logic can be unit tested independently
