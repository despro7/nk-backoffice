# üç™ –°–∏—Å—Ç–µ–º–∞ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å Cookies

## üìã –û–±–∑–æ—Ä

–ú—ã —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ—à–ª–∏ —Å localStorage –Ω–∞ cookies –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –≠—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–±–ª–µ–º—É `Failed to fetch` –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—É—é —Ä–∞–±–æ—Ç—É —Å–∏—Å—Ç–µ–º—ã.

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Cookies –Ω–∞–¥ localStorage

- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞** - cookies –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å –∫–∞–∂–¥—ã–º HTTP –∑–∞–ø—Ä–æ—Å–æ–º
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –Ω–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç JavaScript –∏ —Ä–∞–±–æ—Ç–∞—é—Ç –¥–∞–∂–µ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å fetch API
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - HttpOnly —Ñ–ª–∞–≥ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç XSS –∞—Ç–∞–∫
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** - –±—Ä–∞—É–∑–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Å—Ç–µ—á–µ–Ω–∏–µ–º cookies
- **–ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å setInterval** - —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–∫–ª–∞–¥–∫–∞—Ö

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å

#### 1. Middleware
- **cookie-parser** - –ø–∞—Ä—Å–∏–Ω–≥ cookies
- **CORS —Å credentials: true** - —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ cookies –º–µ–∂–¥—É –¥–æ–º–µ–Ω–∞–º–∏

#### 2. AuthService
```typescript
// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ cookies
static async setAuthCookies(res: Response, accessToken: string, refreshToken: string)

// –û—á–∏—Å—Ç–∫–∞ cookies
static async clearAuthCookies(res: Response)

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑ cookies
static async getTokenFromCookies(req: Request)
```

#### 3. –ú–∞—Ä—à—Ä—É—Ç—ã
- **POST /api/auth/register** - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π cookies
- **POST /api/auth/login** - –≤—Ö–æ–¥ —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π cookies
- **POST /api/auth/refresh** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- **POST /api/auth/logout** - –≤—ã—Ö–æ–¥ —Å –æ—á–∏—Å—Ç–∫–æ–π cookies
- **GET /api/auth/profile** - –ø–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ cookies

### –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å

#### 1. AuthContext
- –£–±—Ä–∞–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç localStorage
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∫–∞–∂–¥—ã–µ 14 –º–∏–Ω—É—Ç
- –°—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–∫–ª–∞–¥–æ–∫ (Page Visibility API)
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### 2. useApi
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ `credentials: 'include'`
- –û–±—Ä–∞–±–æ—Ç–∫–∞ 401 –æ—à–∏–±–æ–∫ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –≤—ã—Ö–æ–¥–æ–º

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –°–µ—Ä–≤–µ—Ä
```typescript
// server/index.ts
app.use(cors({
  origin: process.env.CLIENT_URL || 'http://localhost:3000',
  credentials: true // –í–∞–∂–Ω–æ –¥–ª—è cookies
}));
app.use(cookieParser());
```

### Cookies
```typescript
// Access Token (15 –º–∏–Ω—É—Ç)
{
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'strict',
  maxAge: 15 * 60 * 1000,
  path: '/'
}

// Refresh Token (7 –¥–Ω–µ–π)
{
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'strict',
  maxAge: 7 * 24 * 60 * 60 * 1000,
  path: '/'
}
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
```typescript
const { login } = useAuth();

const success = await login({
  email: 'user@example.com',
  password: 'password123'
});

if (success) {
  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É
  // Cookies —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
}
```

### API –∑–∞–ø—Ä–æ—Å—ã
```typescript
const { apiCall } = useApi();

// Cookies –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è
const response = await apiCall('/api/protected/endpoint');
```

### –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
```typescript
const { logout } = useAuth();

await logout(); // Cookies –æ—á–∏—â–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –¢–µ—Å—Ç cookies —Å–∏—Å—Ç–µ–º—ã
```bash
# –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
test-cookies-browser.html
```

### 2. –¢–µ—Å—Ç AuthContext
```bash
# –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
test-auth-context.html
```

### 3. Node.js —Ç–µ—Å—Ç
```bash
node test-cookies-auth.js
```

## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
1. **–û—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–π–º–µ—Ä** - –∫–∞–∂–¥—ã–µ 14 –º–∏–Ω—É—Ç
2. **Page Visibility API** - –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
3. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏** - mousemove, keypress, scroll, etc.
4. **API fallback** - –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ 401 –æ—à–∏–±–∫–∏

### –õ–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
```typescript
// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
setInterval(() => {
  const timeSinceLastRefresh = Date.now() - lastActivityTime;
  if (timeSinceLastRefresh > 14 * 60 * 1000) {
    refreshToken();
  }
}, 5 * 60 * 1000);
```

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### HttpOnly Cookies
- –ó–∞—â–∏—Ç–∞ –æ—Ç XSS –∞—Ç–∞–∫
- JavaScript –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ç–æ–∫–µ–Ω–∞–º

### SameSite: Strict
- –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF –∞—Ç–∞–∫
- Cookies –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –Ω–∞ —Ç–æ—Ç –∂–µ —Å–∞–π—Ç

### Secure Flag
- –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ cookies —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –ø–æ HTTPS
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ NODE_ENV

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ç–æ–∫–µ–Ω–∞–º–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –ú–µ—Ç—Ä–∏–∫–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö –≤—Ö–æ–¥–æ–≤
- –ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- –û—à–∏–±–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

## üö® –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏
- –ù–µ –≤—ã–∑—ã–≤–∞–µ–º forceLogout –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ—è—Ö

### –ò—Å—Ç–µ–∫—à–∏–µ —Ç–æ–∫–µ–Ω—ã
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã—Ö–æ–¥ –ø—Ä–∏ 401
- –û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –ù–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
- –ü—Ä–æ–≤–µ—Ä–∫–∞ lastActivityAt –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–π –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

## üîÆ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. Refresh Token Rotation
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ refresh token –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
- –û—Ç–∑—ã–≤ —Å—Ç–∞—Ä—ã—Ö refresh —Ç–æ–∫–µ–Ω–æ–≤

### 2. Device Management
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∑—ã–≤–∞ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

### 3. Rate Limiting
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π

### 4. Analytics
- –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ cookies –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É `Failed to fetch` –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - —Ç–æ–∫–µ–Ω—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –∑–∞—â–∏—Ç–∞ –æ—Ç XSS –∏ CSRF
- ‚úÖ **–£–¥–æ–±—Å—Ç–≤–æ** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å –∑–∞–ø—Ä–æ—Å–∞–º–∏
- ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å setInterval
- ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ production —Å—Ä–µ–¥–µ! üéâ
