# Следующие шаги по реструктуризации БД

## Текущий статус
✅ База данных обновлена через `prisma db push`
✅ Удалены неиспользуемые таблицы
✅ Переименованы таблицы в понятные названия
❌ Prisma клиент не сгенерирован (проблема с правами доступа)

## Проблема с правами доступа
Ошибка: `EPERM: operation not permitted` при генерации Prisma клиента

### Решения (попробовать по порядку):

1. **Перезапуск IDE/терминала**
   ```bash
   # Закрыть все терминалы и VS Code
   # Открыть заново и попробовать:
   npx prisma generate
   ```

2. **Очистка кэша npm**
   ```bash
   npm cache clean --force
   rm -rf node_modules
   npm install
   npx prisma generate
   ```

3. **Запуск от имени администратора**
   - Открыть PowerShell от имени администратора
   - Перейти в папку проекта
   - Выполнить `npx prisma generate`

4. **Временное отключение антивируса**
   - Некоторые антивирусы блокируют операции с DLL файлами

## После успешной генерации клиента

### 1. Обновить схему с refresh токенами
```prisma
model User {
  // ... существующие поля ...
  refreshToken      String?        // Храним refresh token прямо в таблице
  refreshTokenExpiresAt DateTime?  // Время истечения
}
```

### 2. Обновить сервис аутентификации
- Изменить логику работы с refresh токенами
- Убрать обращения к таблице `refresh_tokens`
- Обновить типы в `server/types/auth.ts`

### 3. Протестировать функциональность
- Регистрация/вход пользователей
- Обновление токенов
- Выход из системы
- Проверка работы с заказами

### 4. Создать финальную миграцию
```bash
npx prisma migrate dev --name final_restructure
```

## Альтернативный план (если Prisma не работает)

### 1. Использовать прямые SQL запросы
- Создать SQL скрипты для всех операций
- Обновить сервисы для работы с raw SQL

### 2. Временное решение с текущей схемой
- Оставить таблицу `refresh_tokens` пока не решим проблему
- Продолжить работу с текущей структурой

## Проверка состояния БД

### Текущие таблицы:
```sql
SHOW TABLES;
```

### Структура таблицы users:
```sql
DESCRIBE users;
```

### Проверка данных:
```sql
SELECT COUNT(*) FROM users;
SELECT COUNT(*) FROM orders;
SELECT COUNT(*) FROM products;
```

## Резервное копирование
Перед любыми изменениями создать резервную копию:
```bash
mysqldump -u username -p database_name > backup_$(date +%Y%m%d_%H%M%S).sql
```

## Контакты для помощи
- Команда DevOps - для решения проблем с правами доступа
- Команда Backend - для обновления кода
- DBA - для консультаций по структуре БД
