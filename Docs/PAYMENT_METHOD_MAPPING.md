# Мапінг методів оплати SalesDrive → Dilovod

## Огляд

Система експорту замовлень з SalesDrive в Dilovod тепер підтримує **гранулярне мапування на рівні (канал × метод оплати)** замість простого мапування тільки за каналом.

### Чому це важливо?

В реальних замовленнях з SalesDrive канал продажів (`sajt`) визначає джерело замовлення (наприклад, "nk-food.shop", "prom.ua"), але **один канал може приймати різні методи оплати**:
- LiqPay
- Післяплата
- Plata by Mono
- Card
- Apple Pay
- Наложений платіж
- Пром-оплата
- Google Pay
- Credit
- Готівка

Кожен метод оплати може потребувати **різної форми оплати та рахунку в Dilovod**, що впливає на визначення фірми-власника документа.

## Архітектура рішення

### 1. Оновлені типи (`shared/types/dilovod.ts`)

```typescript
export interface DilovodChannelMapping {
  id: string;
  channelId: string;
  salesDrivePaymentMethod?: number;  // ← ID методу оплати з SalesDrive (13, 25, etc.)
  paymentForm?: string;
  cashAccount?: string;
}
```

**До змін**: Один канал → один мапінг (paymentForm + cashAccount)  
**Після змін**: Один канал → багато мапінгів (для кожного методу оплати свій paymentForm + cashAccount)

**Важливо**: `salesDrivePaymentMethod` тепер зберігає **числовий ID** методу оплати з SalesDrive API, а не текстову назву!

### 2. Логіка підбору мапінгу (`DilovodExportBuilder.ts`)

#### Метод `getChannelMapping()`

```typescript
private getChannelMapping(context: ExportBuildContext): DilovodChannelMapping | null {
  const { order, settings, warnings } = context;

  // Крок 1: Отримуємо канал з замовлення
  const channelId = order.sajt;  // наприклад: "1" (nk-food.shop)
  
  // Крок 2: Отримуємо ID методу оплати з rawData (числовий ID з SalesDrive)
  let paymentMethodId: number | undefined;
  try {
    const rawData = typeof order.rawData === 'string' ? JSON.parse(order.rawData) : order.rawData;
    paymentMethodId = rawData?.payment_method;  // наприклад: 13 (LiqPay)
  } catch (error) {
    warnings.push(`Помилка парсингу rawData.payment_method`);
  }
  
  // Крок 3: Шукаємо мапінг за ДВОМА параметрами (channelId + paymentMethodId)
  const mapping = channelSettings.mappings?.find(m => 
    m.salesDrivePaymentMethod === paymentMethodId
  );
  
  if (!mapping) {
    warnings.push(
      `Мапінг методу оплати ID=${paymentMethodId} для каналу ${channelId} не знайдено. ` +
      `Перевірте налаштування в розділі "Налаштування Dilovod" → "Мапінг каналів оплати".`
    );
    return null;
  }
  
  return mapping;
}
```

**Ключові моменти**:
1. Метод оплати береться з **`rawData.payment_method`** (числовий ID), а не з `order.paymentMethod` (текстова назва)
2. Мапінг шукається за **числовим ID**: `m.salesDrivePaymentMethod === paymentMethodId`
3. Це дозволяє створювати багато мапінгів для одного каналу з різними методами оплати

### 3. UI для налаштування (`DilovodSettingsManager.tsx`)

#### Структура форми для кожного мапінгу:

```
┌─────────────────────────────────────────────────────┐
│ Мапінг #1                                     [×]   │ ← Номер мапінгу
├─────────────────────────────────────────────────────┤
│ Метод оплати з SalesDrive: [LiqPay ▼]              │ ← Вибір методу з SalesDrive
│ (з замовлення)                                      │
│ ⚠ Цей метод буде використовуватись...              │
├──────────────────────┬──────────────────────────────┤
│ Форма оплати Dilovod │ Рахунок в Dilovod           │
│ [Безготівка ▼]       │ [Monobank ▼]                │
│ (куди мапити)        │ (визначає фірму)            │
└──────────────────────┴──────────────────────────────┘
```

#### Валідація

```typescript
const isSalesDrivePaymentMethodUsedInChannel = (
  salesDrivePaymentMethod: string, 
  channelId: string, 
  excludeMappingId?: string
): boolean => {
  return channelSettings.mappings.some(m => 
    m.salesDrivePaymentMethod === salesDrivePaymentMethod && 
    m.id !== excludeMappingId
  );
};
```

**Захист від дублікатів**: В межах одного каналу не можна створити два мапінги з однаковим методом оплати SalesDrive.

## Приклад використання

### Сценарій 1: Інтернет-магазин з різними методами оплати

**Канал**: `"1"` (nk-food.shop)

**Мапінги**:

| SalesDrive метод | ID  | Dilovod форма оплати | Dilovod рахунок | Фірма-власник      |
|------------------|-----|----------------------|------------------|--------------------|
| LiqPay           | 13  | Безготівка           | Monobank         | ФОП Іваненко       |
| Післяплата       | 12  | Післяплата           | Нова пошта       | ФОП Іваненко       |
| Готівка          | 15  | Готівка              | Каса             | ТОВ "Рітейл"       |

**Результат**: Замовлення з `rawData.payment_method: 13` (LiqPay) буде експортоване з рахунком Monobank (власник: ФОП Іваненко), а замовлення з `payment_method: 12` (Післяплата) — з рахунком Нова пошта (власник: ФОП Іваненко).

### Сценарій 2: Маркетплейс Prom.ua

**Канал**: `"3"` (prom.ua)

**Мапінги**:

| SalesDrive метод | ID  | Dilovod форма оплати | Dilovod рахунок | Фірма-власник      |
|------------------|-----|----------------------|------------------|--------------------|
| Пром-оплата      | 27  | Безготівка           | Prom.ua Wallet   | ТОВ "Промспілка"   |
| Наложений платіж | 25  | Післяплата           | Укрпошта         | ТОВ "Промспілка"   |

## Як налаштувати

### Крок 1: Відкрити налаштування Dilovod

`Налаштування` → `Dilovod` → прокрутити до секції **"Мапінг каналів оплати"**

### Крок 2: Додати канал (якщо потрібно)

Натиснути `+ Додати канал` та обрати канал зі списку (наприклад, "nk-food.shop").

### Крок 3: Налаштувати мапінги для каналу

Для кожного **методу оплати**, що може прийти з цього каналу:

1. Натиснути `+ Додати мапінг`
2. **Метод оплати з SalesDrive**: Обрати зі списку (наприклад, "LiqPay")
3. **Форма оплати в Dilovod**: Обрати форму (наприклад, "Безготівка")
4. **Рахунок в Dilovod**: Обрати рахунок (наприклад, "Monobank")

### Крок 4: Зберегти

Натиснути `Зберегти налаштування`.

## Визначення фірми

Фірма документа визначається **за власником рахунку**:

```
1. cashAccount.owner (пріоритет!) → Фірма-власник рахунку
2. settings.defaultFirmId → Фірма за замовчуванням
3. ERROR → "Не вказано фірму за замовчуванням"
```

**Приклад**:
- Рахунок "Monobank" (ID: 2207) має власника "ФОП Іваненко" (ID: 2095)
- При експорті замовлення з `paymentMethod: "LiqPay"` буде використаний рахунок "Monobank"
- Фірма документа автоматично стане "ФОП Іваненко" (2095)

## Тестування

### Тест 1: Перевірити експорт з різними методами оплати

```powershell
# Запустити dev server
npm run dev

# Виконати експорт замовлення з LiqPay
.\scripts\test-export.ps1 12345

# Перевірити payload:
# - header.paymentForm повинен бути "Безготівка"
# - header.cashAccount повинен бути ID рахунку Monobank
# - header.firm повинен бути ID фірми-власника Monobank
```

### Тест 2: Перевірити валідацію UI

1. Відкрити налаштування Dilovod
2. Додати два мапінги з однаковим методом оплати
3. Переконатися, що другий селектор показує "(Вже використовується в цьому каналі)"

### Тест 3: Перевірити попередження

Виконати експорт замовлення з методом оплати, для якого **немає мапінгу**:

```json
{
  "sajt": "1",
  "rawData": {
    "payment_method": 999
  }
}
```

**Очікуваний результат**: Попередження в payload:
```
"Мапінг методу оплати ID=999 для каналу 1 не знайдено"
```

## Міграція існуючих налаштувань

Якщо у вас вже є налаштування з **старою схемою** (без `salesDrivePaymentMethod`):

1. Відкрийте налаштування Dilovod
2. Для кожного каналу оберіть метод оплати для існуючих мапінгів
3. Додайте нові мапінги для інших методів оплати (якщо потрібно)
4. Збережіть

**Важливо**: Мапінги без вказаного `salesDrivePaymentMethod` **не будуть використовуватись** при експорті!

## Технічні деталі

### Динамічне завантаження методів оплати

Методи оплати завантажуються **з SalesDrive API** через ендпоінт `/api/payment-methods/`:

```typescript
// Backend: salesDriveService.fetchPaymentMethods()
const paymentMethods = await salesDriveService.fetchPaymentMethods();
// Повертає: [{id: 14, name: 'Plata by Mono'}, {id: 13, name: 'LiqPay'}, ...]

// Frontend: DilovodSettingsManager.tsx
const response = await fetch('/api/dilovod/salesdrive/payment-methods');
const data = await response.json();
setPaymentMethods(data.data);
```

**Кешування**: Результат кешується на **1 годину** для зменшення навантаження на SalesDrive API.

**Fallback**: Якщо API недоступний, використовується хардкоджений список як резервний варіант.

**Важливо**: Тепер використовуються **числові ID** методів оплати (13, 14, 25...), а не текстові назви.

### Залежності

**Frontend**:
- `@heroui/select` - компонент випадаючого списку
- `lucide-react` - іконки методів оплати

**Backend**:
- `prisma` - ORM для завантаження замовлень
- `DilovodService` - API клієнт Dilovod
- `logWithTimestamp` - логування процесу експорту

## Відомі обмеження

1. **Залежність від SalesDrive API**: Методи оплати завантажуються з `/api/payment-methods/`. Якщо API недоступний, використовується fallback список (може бути застарілим).
2. **Кешування на 1 годину**: Нові методи оплати з'являться у списку тільки після очищення кешу або через 1 годину.
3. **Немає можливості мапити за regex**: Можна тільки точне співставлення числових ID методів оплати.
4. **Немає можливості вказати декілька методів в один мапінг**: Один мапінг = один метод оплати (один числовий ID).
5. **Поле `payment_method` обов'язкове**: Якщо у замовленні відсутнє `rawData.payment_method`, експорт не вдасться.

## Подальший розвиток

- [x] Додати API для отримання списку методів оплати з SalesDrive ✅
- [ ] Додати кнопку оновлення методів оплати (очищення кешу)
- [ ] Додати можливість створення кастомних методів оплати (для локального тестування)
- [ ] Додати можливість мапити за патерном (regex)
- [ ] Додати візуалізацію покриття методів оплати (які методи не мають мапінгу)
- [ ] Додати статистику використання методів оплати з реальних замовлень
- [ ] Додати bulk-import мапінгів з CSV/JSON файлу

## Версія

- **Дата створення**: 2025-01-17
- **Версія**: 1.0.0
- **Автор**: GitHub Copilot (за запитом користувача)
