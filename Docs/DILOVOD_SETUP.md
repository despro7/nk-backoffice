# Настройка интеграции с Dilovod

## Обзор

Интеграция с Dilovod позволяет получать информацию о товарах, их ценах, остатках и комплектах в реальном времени.

## Настройка переменных окружения

Создайте файл `.env` в корне проекта и добавьте следующие переменные:

```env
# Dilovod API
DILOVOD_API_URL=https://your-dilovod-instance.com/api
DILOVOD_API_KEY=your-api-key-here

# WordPress Database (для получения SKU товаров)
WORDPRESS_DATABASE_URL=mysql://user:password@localhost:3306/wordpress_db
```

## Функции API

### 1. Получение остатков товаров

**Endpoint:** `GET /api/products/stock/balance`

**Параметры:**
- `sync` (query, optional): `true` для запуска синхронизации, `false` для получения данных из кеша

**Пример запроса:**
```bash
# Получить данные из кеша
GET /api/products/stock/balance

# Запустить синхронизацию и получить свежие данные
GET /api/products/stock/balance?sync=true
```

### 2. Синхронизация товаров с Dilovod

**Endpoint:** `POST /api/products/sync`

**Права доступа:** Только для пользователей с ролями `admin` и `boss`

**Описание:** 
Функция выполняет полную синхронизацию товаров с Dilovod, включая:
- Получение SKU товаров в наличии из WordPress
- Запрос информации о товарах и ценах из Dilovod
- Обработка комплектов товаров (наборов)
- Сохранение/обновление данных в локальной базе

**Логика работы (аналог PHP функции `getGoodsInfoWithSetsOptimized`):**

1. **Получение основных данных:**
   - Запрос к регистру `goodsPrices` для получения цен по SKU
   - Сбор информации о типах цен и категориях

2. **Обработка комплектов:**
   - Идентификация комплектов по parent ID `1100300000001315`
   - Детальный запрос `getObject` для получения состава комплекта
   - Парсинг таблицы `tpGoods` для извлечения компонентов

3. **Формирование результата:**
   - Основная цена (розничная для интернет-магазина)
   - Дополнительные цены по типам
   - Категоризация товаров
   - Состав комплектов с количеством

**Ответ:**
```json
{
  "success": true,
  "message": "Синхронизация завершена успешно",
  "syncedProducts": 150,
  "syncedSets": 25,
  "errors": []
}
```

## Структура данных

### DilovodProduct
```typescript
interface DilovodProduct {
  id: string;           // ID товара в Dilovod
  name: string;         // Название товара
  sku: string;          // SKU товара
  costPerItem: string;  // Основная цена
  currency: string;     // Валюта (UAH)
  category: {
    id: number;         // ID категории
    name: string;       // Название категории
  };
  set: Array<{          // Состав комплекта
    id: string;         // SKU компонента
    quantity: number;   // Количество
  }>;
  additionalPrices: Array<{
    priceType: string;  // Тип цены
    priceValue: string; // Значение цены
  }>;
}
```

### Типы цен
- `1101300000001001` - Роздріб (Інтернет-магазин) - основная цена
- `1101300000001006` - Акційна
- `1101300000001003` - Дрібний опт
- `1101300000001004` - Опт (мережі магазинів)
- `1101300000001005` - Роздріб (Розетка)
- `1101300000001002` - Дрібний опт (Славутич)
- `1101300000001008` - Вако трейд
- `1101300000001012` - Військові
- `1101300000001007` - Звичайна
- `1101300000001013` - Роздріб(Пром)

### Категории
- `1` - Перші страви
- `2` - Другі страви  
- `3` - Набори продукції

## Использование в интерфейсе

### Страница "Комплекти товарів"

На странице доступны следующие функции:

1. **Кнопка синхронизации:**
   - Запускает полную синхронизацию с Dilovod
   - Доступна только для администраторов и руководителей
   - Показывает прогресс выполнения

2. **Статус синхронизации:**
   - Отображает текущий статус процесса
   - Показывает количество синхронизированных товаров и комплектов
   - Выводит ошибки, если они возникли

3. **Таблица товаров:**
   - Отображает все синхронизированные товары
   - Показывает состав комплектов
   - Время последнего обновления

## Обработка ошибок

Функция синхронизации включает комплексную обработку ошибок:

- **Ошибки API:** Логирование и возврат детального описания
- **Ошибки базы данных:** Продолжение работы с другими товарами
- **Ошибки сети:** Повторные попытки и fallback на кеш
- **Ошибки валидации:** Пропуск некорректных данных

## Производительность

- **Кеширование SKU:** WordPress SKU кешируются на 24 часа
- **Задержки API:** 150ms между запросами для избежания перегрузки
- **Пакетная обработка:** Обработка товаров группами
- **Асинхронность:** Параллельная обработка комплектов

## Мониторинг

Все операции логируются в консоль сервера:
- Начало и завершение синхронизации
- Количество обработанных товаров
- Ошибки и предупреждения
- Время выполнения операций

## Тестирование

Для тестирования функции синхронизации:

1. Убедитесь, что настроены переменные окружения
2. Запустите сервер: `npm run dev`
3. Откройте страницу "Комплекти товарів"
4. Нажмите "Синхронізувати з Dilovod"
5. Проверьте логи сервера и статус в интерфейсе
